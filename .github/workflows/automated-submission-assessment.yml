name: Automated Submission Assessment

on:
  push:
    branches:
      - 2025.1
    paths:
      - 'assignments/**/submissions/**'
  pull_request:
    branches:
      - 2025.1
    paths:
      - 'assignments/**/submissions/**'
  workflow_dispatch: 

jobs:
  test-assignments-submissions:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Detect task
      id: detect-task
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_REF="origin/${{ github.event.pull_request.base.ref }}"
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
        else
          BASE_REF="${{ github.event.before }}"
        fi

        MODIFIED_FILES=$(git diff --name-only $BASE_REF ${{ github.sha }})

        MODIFIED_TASK=$(echo "$MODIFIED_FILES" | grep 'assignments/' | cut -d '/' -f2 | sort -u | head -n 1)

        MODIFIED_STUDENT=$(echo "$MODIFIED_FILES" | grep 'submissions/' | cut -d '/' -f4 | sort -u | head -n 1)

        if [ -z "$MODIFIED_TASK" ] || [ -z "$MODIFIED_STUDENT" ]; then
          echo "❌ Erro: Nenhuma alteração detectada no diretório correto (assignments/**/submissions/**)"
          exit 1
        fi

        echo "Tarefa detectada: $MODIFIED_TASK"
        echo "task_dir=$MODIFIED_TASK" >> $GITHUB_ENV

        echo "Aluno detectado: $MODIFIED_STUDENT"
        echo "student_dir=$MODIFIED_STUDENT" >> $GITHUB_ENV

    - name: Set up JDK 21
      uses: actions/setup-java@v2
      with:
        distribution: 'zulu'
        java-version: '21'

    - name: Set up submission directory, compile code and run tests
      run: |
        cd assignments/${{ env.task_dir }}/submissions/${{ env.student_dir }}/
        ls -R
        mkdir -p lib
        curl -L -o lib/junit-platform-console-standalone-1.11.4.jar https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.11.4/junit-platform-console-standalone-1.11.4.jar
        javac -cp "lib/*" -d bin src/*.java ../../test/*.java
        java -jar lib/junit-platform-console-standalone-1.11.4.jar --class-path bin --scan-class-path
